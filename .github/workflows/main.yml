name: Weekly Paper Pipeline

# 1. 触发器：什么时候运行？
on:
  # 定时任务：国际标准时间 (UTC) 每周一 00:00 运行
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch:

# 2. 任务主体
jobs:
  run-downloader:
    name: Download New Papers
    runs-on: ubuntu-latest # 使用 GitHub 提供的最新 Ubuntu 虚拟机

    steps:
      # 第一步：把你的代码从仓库里拉取下来
      - name: Checkout code
        uses: actions/checkout@v3

      # 第二步：在这个虚拟机上安装 Python 3.12
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # 第三步：安装依赖包
      - name: Install dependencies
        run: |
          cd server
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 第四步：运行你的下载脚本
      - name: Run Pipeline Script
        # 把刚才配置的 Secrets 注入成环境变量，脚本里的 os.getenv 才能读到
        env:
          USE_SUPABASE: ${{ secrets.USE_SUPABASE }}
          SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}
          LLAMA_CLOUD_API_KEY: ${{ secrets.LLAMA_CLOUD_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_PAPERS_BUCKET: ${{ secrets.SUPABASE_PAPERS_BUCKET }}
          SUPABASE_REPORTS_BUCKET: ${{ secrets.SUPABASE_REPORTS_BUCKET }}
          BACKEND_CORS_ORIGINS: ${{ secrets.BACKEND_CORS_ORIGINS }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          WRITING_MODEL_NAME: ${{ secrets.WRITING_MODEL_NAME }}
          WRITING_MODEL_TEMPERATURE: ${{ secrets.WRITING_MODEL_TEMPERATURE }}
          DEDUCE_MODEL_NAME: ${{ secrets.DEDUCE_MODEL_NAME }}
          EMBEDDING_MODEL_NAME: ${{ secrets.EMBEDDING_MODEL_NAME }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
        run: |
          echo "Starting pipeline..."
          cd server
          python -m run_weekly_report
          echo "Pipeline finished!"
